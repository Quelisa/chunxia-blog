---
title: BERT 知多少
date: 2021-03-02 16:40:29
tags:
- BERT
categories: 
- 预训练语言模型
mathjax: true
---

BERT已经提出三四年了，但是提到NLP首先想到的还是Transformer[1]、BERT[2]。像经典的CNN、RNN一样BERT也可以说Transformer也一定在会在NLP和人工智能的舞台上留下浓墨重彩的一笔，如此经典的神经网络模型，当然值得不断深入的思考和学习啦！
<!--more-->


### Transformer和CNN、RNN的区别是什么，本质是什么？
这三个模型其实是代表了三种典型的神经网络。RNN代表的是循环神经网络，CNN代表的是卷积神经网络，而transformer代表的是注意力机制下的神经网络。所以要理解他们之间的区别就要了解这三种神经网络的特性。理解这三种神经网络的特点首先要了解神经网络的发展过程。


最初的神经网络发展自单层感知机，由于单层感知机只是将特征加权后输出，所以不具备处理非线性问题的能力，也导致神经网络发展停滞，直到出现多层神经网络加激活函数形式的多层感知机，神经网络才再度出现在人们的视野。研究人员开始研究多层感知机的优化，首先是各种各样的激活函数的出现，随着计算机硬件能力的不断提高，通过加深网络，和提高参数量，神经网络获得了很大的进展。但是，多层感知机的全连接网络由于设计简单，对于所有的特征提取没有区分度，所以在处理复杂的数据例如图像数据、序列数据时就会显得力不从心。随着计算机视觉和自然语言处理的发展，深度学习和对应的领域进行融合，于是发展出了专为图像数据而设计的卷积神经网络CNN以及专为文本序列处理而设计的循环卷积网络RNN。在这两种模式的神经网络取得成功后，研究人员迅速改进了RNN和CNN发展出了基于这两种神经网络的各种现代网络，但是核心思想是不变的。之后，研究人员还在神经网络中引入了注意力机制。而Transformer的出现是神经网络发展中另一个具有里程碑意义的模型结构。Transformer完全抛弃了CNN和RNN，采用多头注意力机制（multi-head attention）和自注意力（self-attention），Transformer的大获成功在很大程度上诠释了基于自注意力机制神经网络的超强能力。下面就深入细节，具体感受一下各种神经网络的不同。


#### (1) 卷积神经网络CNN[3]
卷积神经网络的核心思想在于它考虑了数据的局部空间特性，以及数据的平移不变性，在此基础上进行特征提取。因此，CNN引入了一个重要的概念“卷积”，在网络上结构中主要体现在引入了卷积层，卷积层的权重就是卷积核。引入卷积层的神经网络较多层感知机可以极大地减少参数。下图是一个典型卷积神经网络的代表。可以看到网络中主要包括卷积层和汇聚层也称池化层，最后的输出是一个全连接层。
<img src="https://github.com/Quelisa/picture/raw/main/DNN/LeNet.png" width="70%" height="50%">


要想深入地了解CNN，就需要深入了解卷积层的操作，下面来介绍卷积相关的概念和操作。首先了解什么卷积？在数学中，两个函数（$ f,g:\mathbb{R}^d \to \mathbb{R} $）之间的卷积被定义为：

$$ (f*g)(\pmb{x}) = \int {f(\pmb{z})g(\pmb{x}-\pmb{z})dz} \qquad (1)$$

也就是说，卷积是把一个函数“翻转”并移位$ \bf{x} $时，测量$f$和$g$之前的重叠。当为离散对象时，积分就变成求和：

$$ (f*g)(i) = \sum_a {f(a)g(i-a)} \qquad (2) $$

对于二维张量，则$f$的索引为$(a,b)$和$g$的索引$(i-a, j-b)$上的对应加和:

$$ (f*g)(i,j) = \sum_a{\sum_b {f(a,b)g(i-a,i-b)}} \qquad (3) $$

严格来说，卷积层做的操作不是卷积运算而是互相关运算，卷积层对输⼊和卷积核权重进⾏互相关运算，并在添加标量偏置之后产⽣输出。所以，卷积层中的两个被训练的参数是卷积核权重和标量偏置。就像我们之前随机初始化全连接层⼀样，在训练基于卷积层的模型时，我们也随机初始化卷积核权重。


影响卷积输出的大小主要是填充（padding）和步幅（stride）。⽐如，⼀个240 × 240像素的图像，经过10层5 × 5的卷积后，将减少到200 × 200像素。如此⼀来，原始图像的边界丢失了许多有⽤信息。⽽填充是解决此问题最有效的⽅法。有时，我们可能希望⼤幅降低图像的宽度和⾼度。例如，如果我们发现原始的输⼊分辨率⼗分冗余。步幅则可以在这类情况下提供帮助。卷积神经网络中还有一个重要的概念是通道，通道的作用我理解就是不同的特征提取器，拿图像举例，图像中一个像素点需要三个维度的数据来表示（RGB），那么其中每一个维度就需要一个通道，一个通道就对应一个卷积层。当然，随着CNN的发展也出现了各种各样的卷积操作，其中包括转置(Transposed)卷积，可分离卷积，扩张/空洞(Dilated/Atrous)卷积以及可变形(Deformable)卷积等。


除了最核心的卷积层外，CNN还有一个关键的网络层汇聚层，一般的神经网络在每一次卷积操作之后都会接一个汇聚层，对前一层提取的特征进行采样。因为卷积层更多的关注空间的局部特征，所以加入汇聚层可以更好的捕捉空间的整体特性。汇聚层主要有最⼤汇聚层和平均汇聚层等。


比较有代表性的卷积神经网络有LeNet、AlexNet、VGG、NiN、GoogLeNet、ResNet以及DenseNet等。

#### (2) 循环神经网络RNN[3]
如果说卷积神经⽹络可以有效地处理空间信息，那么循环神经⽹络则可以更好地处理序列信息。循环神经⽹络通过引⼊状态变量存储过去的信息和当前的输⼊，从⽽可以确定当前的输出。循环神经网络的设计启发来自于序列模型，在文本处理中常使用n元语法模型，但是n元语法模型中单词$x_t$在时间步$t$的条件概率仅取决于前$n-1$个单词，对于更长序列的捕捉，需要更大的$n$,然⽽模型参数的数量也会随之呈指数增⻓。所以不如含使用隐变量的模型：
$$ P(x_t|x_{t-1},...,x_1) \approx P(x_t|h_{t-1}) \qquad (4) $$


其中$$h_{t-1}$$是隐状态，也称为隐变量，它存储了到时间步$$t-1$$的序列信息。通常，我们可以基于当前输入$$x_t$$和先前的隐状态$$h_{t-1}$$来计算时间步$$t$$处的任何时间的隐状态：
$$ h_{t} = f(x_t, h_{t-1}) \qquad (5) $$


循环神经⽹络RNN是具有隐状态的神经⽹络，当然包括隐状态的模型还有隐马尔可夫连、条件随机场等。下面来感受一下含有隐状态的神经网络的建模过程：
假设在时间步$t$有⼩批量输⼊$$X_t \in \mathbb{R}^{n \times d}$$，用$$H_t \in \mathbb{R}^{n \times h}$$表示时间步$t$的隐变量。当前步保存前一个时间步的隐变量$$H_{t-1}$$，引入新的权重参数$$W_{hh} \in \mathbb{R}^{h \times n}$$，来描述如何在当前时间步中使用前一个时间步的隐变量。即当前时间隐藏变量由当前时间步的输入与前一个时间步的隐变量一起计算得出：


$$H_t = \phi (X_t W_{xh} + H_{t-1}W_{hh} + b_h) \qquad (6) $$

由于在当前时间步中，隐状态使⽤的定义与前⼀个时间步中使⽤的定义相同，因此（5）的计算是循环的。于是基于循环计算的隐状态神经⽹络被命名为循环神经⽹络。对于时间步$t$，输出层的输出类似于多层感知机中的计算：

$$O_t = H_t W_{hq} + b_q \qquad (7) $$


循环神经⽹络的参数包括隐藏层的权重$$W_{xh} \in \mathbb{R}^{d \times h}$$，$$W_{hh} \in \mathbb{R}^{h \times h}$$和偏置$$b_h \in \mathbb{R}^{1 \times h}$$，以及输出层的权重$$W_{qh} \in \mathbb{R}^{q \times h}$$和偏置$$b_q \in \mathbb{R}^{1 \times q}$$。值得⼀提的是，即使在不同的时间步，循环神经⽹络也总是使⽤这些模型参数。因此，循环神经⽹络的参数开销不会随着时间步的增加⽽增加。下图是一个RNN的网络层结构：

<img src="https://github.com/Quelisa/picture/raw/main/DNN/RNN.png" width="60%" height="50%">


随着对RNN的深入研究，研究员发明了控制循环门单元、长短记忆网络以及双向RNN等来改善朴素的循环神经⽹络，也使得现代循环神经网络变得越来越复杂。


#### (3) 注意力机制和Transformer
我不知道注意力机制最初的设计灵感来源于哪里，但是看到有关注意力的一段描述，我觉得可以很好的解释为什么我们需要注意力机制。它的原文是这样的：
> 注意⼒是稀缺的，⽽环境中的⼲扰注意⼒的信息却并不少。⽐如我们的视觉神经系统⼤约每秒收到108位的信息，这远远超过了⼤脑能够完全处理的⽔平。幸运的是，我们的祖先已经从经验（也称为数据）中认识到“并⾮感官的所有输⼊都是⼀样的”。在整个⼈类历史中，这种只将注意⼒引向感兴趣的⼀⼩部分信息的能⼒，使我们的⼤脑能够更明智地分配资源来⽣存、成⻓和社交，例如发现天敌、找寻⻝物和伴侣。[3]

通过学习人类的注意力，我们把注意力分为自主性注意力和非自主性注意力。对于简单的感官传入到我们的大脑的刺激是非自主性注意力，对于我们主动选择要查询搜索的刺激是自主性注意力。那么如何用神经网络来设计注意力机制的框架呢？


对于非自主性注意力，可以简单地使⽤参数化的全连接层，甚⾄是⾮参数化的最⼤汇聚层或平均汇聚层。因此，“是否包含⾃主性提⽰”将注意⼒机制与全连接层或汇聚层区别开来。在注意⼒机制的背景下，我们将⾃主性提⽰称为查询（query），非自主查询称为键（key）。注意力机制的设计如下图所示，它展示了一个查询（自助查询）和所有键（非自主查询）通过注意力汇聚产生的结果和感觉输入：值（value）结合作为中间特征输入到神经网络中的过程。
<img src="https://github.com/Quelisa/picture/raw/main/DNN/attention.png" width="60%" height="50%">

实际应用中，假设有一个查询$\pmb{q} \in \mathbb{R}^q$和$m$个“键-值”对$$(\pmb{k}_i, \pmb{v}_i), 1 \leq i \leq k$$，其中$$\pmb{k}_i \in \mathbb{R}^k, \pmb{v}_i \in \mathbb{R}^v$$，注意力汇聚函数$f$通常被表⽰成值的加权和：

$$ f(\pmb{q}, (\pmb{k}_1 , \pmb{v}_1),...,(\pmb{k}_m, \pmb{v}_m)) = \sum_{i=1}^{m} \alpha(\pmb{q}, \pmb{k}_i)\pmb{v}_i \, \in \mathbb{R}^v \qquad (7) $$

其中查询$\pmb{q}$和键$\pmb{k}_i$的注意⼒权重（标量）是通过注意⼒评分函数$\alpha$将两个向量映射成标量，再经过softmax运算得到的：

$$ \alpha(\pmb{q}, \pmb{k}_i) = softmax(\alpha (\pmb{q}, \pmb{k}_i)) = \frac{exp(\alpha (\pmb{q}, \pmb{k}_i))}{\sum_{j=1}^m{exp(\alpha (\pmb{q}, \pmb{k}_j))}} \qquad (8) $$


选择不同的注意⼒评分函数a会导致不同的注意⼒汇聚操作，注意力的不同主要在其评分函数的不同，常用的注意力主要是加性注意力（additive attention）和缩放点积注意⼒（scaled dot-product attention）。⼀般来说，当查询和键是不同⻓度的⽮量时，我们可以使⽤加性注意⼒作为评分函数。给定查询q ∈ Rq和 键k ∈ Rk，加性注意⼒的评分函数为

$$ \alpha(\pmb{q}, \pmb{k}) = \pmb{w}_v^T tanh(\pmb{W}_q \pmb{q} + \pmb{W}_k \pmb{k}) \qquad (9) $$

其中可学习的参数是$$\pmb{W}_q \in \mathbb{R}_{h \times q}$$、$$\pmb{W}_k \in \mathbb{R}_{h \times k}$$和$$\pmb{W}_v \in \mathbb{R}_h$$。如公式（9）所示，将查询和键连结起来后输入到一个多层感知机中，感知机包含一个隐含层，其隐含但愿是一个超参数$h$。通过使用tanh作为激活函数，并禁止使用偏置项。

使⽤点积可以得到计算效率更⾼的评分函数，但是点积操作要求查询和键具有相同的⻓度$d$。假设查询和键的所有元素都是独⽴的随机变量，并且都满⾜零均值和单位⽅差，那么两个向量的点积的均值为0，⽅差为$d$。为确保⽆论向量⻓度如何，点积的⽅差在不考虑向量⻓度的情况下仍然是1，我们将点积除以$\sqrt{d}$，则缩放点积注意⼒评分函数为：

$$ \alpha(\pmb{q},\pmb{k}) = \pmb{q}^T \pmb{k}/{\sqrt{d}} \qquad (10) $$

在实践中，我们通常从小批量的角度来考虑提高效率，例如基于$n$个查询和$m$个键-值对的计算注意力，其中查询和键的长度为$d$，值得长度为$v$。查询$$\pmb{Q} \in \mathbb{R}^{n \times d}$$、键$$\pmb{K} \in \mathbb{R}^{m \times d}$$和值$$\pmb{V} \in \mathbb{R}^{m \times v}$$的缩放点积注意力是：

$$ softmax(\frac{\pmb{Q}\pmb{K}^T}{\sqrt{d}})\pmb{V} \, \in \mathbb{R}^{n \times v} \qquad (11) $$


了解了注意力机制就来看看Transformer是怎么使用这些机制设计神经网络架构的。Transformer使用的是缩放点积的自注意⼒机制，并且是多头的。下面来看一下Transformer的网络结构：
<img src="https://github.com/Quelisa/picture/raw/main/DNN/transformer.png" width="40%" height="70%">

Transformer的采用的是encoder-decoder的架构，bert主要使用了encoder部分。在encoder部分，输入是加上位置编码的embedding，然后输入一个N=6层的encode层，每一个encode层包括两个子层，一个是多头自注意力机制，另一个是基于位置的全连接前馈神经网络，每一部分网络的输出连接一个残差网络和一个归一化层。在decoder部分包含一个N=6层的decode层，每一个encode层包括三个子层，除了包含encode中的两个子层外，还增加了一个mask多头注意力。这里的mask可以遮盖预测位置之后的输出，来确保之后的信息不被泄露。


这里值得一提的是，因为Transformer完全采用注意力机制，不像是CNN或RNN都在网络中包含了位置信息，所以在Transformer的输入中要结合一个位置编码，Transformer使用了$sine$和$cosine$函数作为位置编码：

$$ PE(pos,2i) = sin(pos/10000^{2i/d_model} \qquad (12) $$
$$ PE(pos,2i+1) = sin(pos/10000^{2i/d_model} \qquad (13) $$

其中，$pos$是位置，$i$是维度，$d_{model}$是模型隐含层的维度。也就是说，位置编码的每个维度对应于一个正弦曲线，曲线从$2\pi$到$10000\cdot 2\pi$。有关位置编码的故事可以查看苏神的博客：[让研究人员绞尽脑汁的Transformer位置编码](https://spaces.ac.cn/archives/8130)和[Sinusoidal位置编码追根溯源](https://spaces.ac.cn/archives/8231)。

### 多头自注意力有什么好处
因为自注意力机制是互斥的，也就是说，对于一个语句，一个自注意力机制只能从某个角度出发学习所关注的词的权重，但是可能存在多种关注关系，这时就需要用到多个自注意力头。多头自注意力机制有点类似于CNN中的多卷积核，直观上讲，有助于网络从不同模式中铺捉到更加丰富的特征。



### 从Transformer到BERT
BERT采用了Transformer架构的encode部分，并且在输入的embedding中加入了toke_type。BERT支持同时输入两个句子，并用特殊符号进行拼接开头是[CLS]，两句的中间和最后添加[SEP]。有关[CLS]的解释是可以用作句嵌入的embedding，将CLS上的向量在下游fine-tune后可用作分类或者检索任务等。[SEP]是为了区分输入的两个句子，这个是在BERT预训练的任务中用到的。


由于BERT需要通过上下文信息，来预测中心词的信息，同时又不希望模型提前看见中心词的信息，因此提出了一种Masked Language Model的预训练方式，即随机从输入预料上mask掉一些单词，然后通过的上下文预测该单词，类似于一个完形填空任务。因此BERT相较Transformer是双向的。仅仅一个MLM任务是不足以让BERT解决阅读理解等句子关系判断任务的，因此添加了额外的一个预训练任务，即Next Sequence Prediction。具体任务即为一个句子关系判断任务，即判断句子B是否是句子A的下文。对于不同的下游任务，我们仅需要对BERT不同位置的输出进行处理即可，或者直接将BERT不同位置的输出直接输入到下游模型当中。


### BERT的局限在哪里？
- BERT的预训练任务MLM使得能够借助上下文对序列进行编码，但同时也使得其预训练过程与中的数据与微调的数据不匹配，难以适应生成式任务
- 由于最大输入长度的限制，适合句子和段落级别的任务，不适用于文档级别的任务（如长文本分类）
- 适合处理自然语义理解类任务(NLU)，而不适合自然语言生成类任务(NLG)
- BERT没有考虑预测[MASK]之间的相关性，是对语言模型联合概率的有偏估计


### 参考文献
[1] Vaswani A, Shazeer N, Parmar N, et al. Attention is all you need[J]. Advances in neural information processing systems, 2017, 30.
[2] Devlin J, Chang M W, Lee K, et al. BERT: Pre-training of deep bidirectional transformers for language understanding[J]. arXiv preprint arXiv:1810.04805, 2018.
[3] https://github.com/d2l-ai/d2l-zh